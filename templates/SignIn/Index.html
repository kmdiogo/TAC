{% extends 'Base.html' %}
{% load static %}

{% block title %}TAC &middot; Sign-In{% endblock %}

{% block styles %}
    <style>
    .wrapper{
        transition: opacity 1s ease-in-out;
    }
    .wrapper.hidden{
        opacity: 0;
    }
    .student-or-employee{
        width: 100%;
        height: 200%;
    }

    /*#col-button-employee, #col-button-student {
        margin-top: 15px;
        margin-bottom: 15px;
    }*/

    .student-or-employee:hover{
        /*background-color: grey !important;*/
    }

    .hover-jump:hover{
        animation: jump 1s infinite ease-in-out;
    }

    #content{
        transition: all 2s ease-in-out;
        /*animation: slide-down 1s;*/
    }
    #content.start-up{
        transform: translateY(-5%);
    }
    .wrapper{
        display: flex;
        align-items: stretch;
        width: 100%;

    }
    #sidebar{
        padding: 10px;
        transition: all 0.5s ease-in-out;
        min-width: 250px;
        max-width: 250px;
        min-height: 100vh;
    }
    #sidebar.active{
        margin-left: -250px;
    }
    @media (max-width: 768px) {
        /*#sidebar {
            margin-left: -250px;
        }
        #sidebar.active {
            margin-left: 0;
        }*/
        #col-button-employee, #col-button-student {
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .student-or-employee {
            width: 100%;
            height: 100%;
        }
    }
    #sidebar-links > li > button{
        width: 100%;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    .section {
        display: none;
        width: 100%;
        height: 100%;
    }
    .section.active {
        display: block;
    }
    .section-button {
        transition: background-color 0.2s linear;
    }

</style>
{% endblock %}


{% block content %}
<div class="wrapper hidden">
    <nav id="sidebar" class="active">
        {% include 'SignIn/_Sidebar.html' %}
    </nav>

    <button type="button" id="button-sidebar" class="btn btn-info"><span>III</span></button>

    <div class="start-up" id="content" style="min-height: 100vh;width: 100%;">
        <div class="section active" id="home-section" data-button="#home-button">
            {% include 'SignIn/HomeSection/_HomeSection.html' %}
        </div>
        <div class="section" id="student-section" data-button="#student-button">
            {% include 'SignIn/StudentSection/_StudentSection.html' %}
        </div>
        <div class="section" id="employee-section" data-button="#employee-button">
            {% include 'SignIn/EmployeeSection/_EmployeeSection.html' %}
        </div>
    </div>
</div>
{% endblock %}



{% block scripts %}
<script>
    const SCHOOL_ID_FORMAT = "Y00999999";
    $(document).ready(function(){
        Validators();
        InputMasks();
        $('.wrapper').removeClass('hidden');
        $('#content').removeClass('start-up');
        BindIndexEvents();
    });

    function BindIndexEvents(){
        $('#button-sidebar').click(function(){
            $('#sidebar').toggleClass('active');
        });

        // Switch to the section specified by the button's data-section
        $('.section-button,.student-or-employee').click(function(){
            ChangeSection($(this).data('section'));
        });

        $('#input-StudentSection-schoolId').on('keypress', function(e){
            if (e.which === 13) $('#button-StudentSection-yNumberSubmit').trigger('click');
        });

        $('#button-StudentSection-yNumberSubmit').click(function(){
            $.getJSON("{% url 'school_id_taken' %}", {'schoolId': $('#input-StudentSection-schoolId').val() }, function(data){
                if (!data.isTaken && $('#input-StudentSection-schoolId').inputmask('isComplete')){
                    $('#modal-StudentSection-newStudentModal').modal('show');
                    $('#id_schoolId').val($('#input-StudentSection-schoolId').val());
                    $('#input-StudentSection-schoolId').val('');
                }
            });
        });

        // ALGORITHM:
        // 1. Validate form input using jquery.validate
        // 2. Send AJAX request to ensure schoolId isn't taken
        // 3. Send form POST request
        // 4. Show success screen if POST request returned successful
        $('#button-StudentSection-newStudentSubmit').click(function(){
            if (!$('#form-StudentSection-newStudent').valid() || !$('#id_schoolId').inputmask("isComplete"))
                return;
            let sendData = { 'schoolId': $('#id_schoolId').val() };
            $.getJSON("{% url 'school_id_taken' %}", sendData, function(data) {
                if (data.isTaken){
                    // Shake error message
                    RestartAnimation($('#text-StudentSection-schoolIdTaken'), 'shake-3');
                    return;
                }

                // Show loading icon. Send POST request. If response returned was successful, show success screen
                $('#icon-StudentSection-newStudentLoading').show();
                let postData = $('#form-StudentSection-newStudent').serialize();
                $.post("{% url 'create_student' %}", postData, function(data){
                    $('#icon-StudentSection-newStudentLoading').hide();
                    if (data.student_is_valid){
                        $('#button-StudentSection-newStudentClose,#button-StudentSection-newStudentSubmit').fadeOut();
                        $('#StudentSection-newStudentFormBody').fadeOut().promise().done(function(){
                            $('#StudentSection-newStudentSuccessScreen').fadeIn();
                        });
                    }
                    else {
                        alert("Something went wrong!");
                    }
                });
            });
        });

        // Verify schoolId has not been used already every time the input field changes value
        $('#id_schoolId').on('change keyup paste',function(){
            //let newStudentSchoolId = $('#form-student')
            if (!$('#id_schoolId').inputmask('isComplete')){
                $('#text-StudentSection-schoolIdTaken').hide();
                return;
            }
            let sendData = { 'schoolId': $('#id_schoolId').val() };
            $('#icon-StudentSection-newStudentLoading').show();
            $.getJSON("{% url 'school_id_taken' %}", sendData, function(data){
                $('#icon-StudentSection-newStudentLoading').hide();
                if (data.isTaken)
                    $('#text-StudentSection-schoolIdTaken').show();
                else
                   $('#text-StudentSection-schoolIdTaken').hide();
            });
        });

        // Reset new student form when the modal closes
        $('#modal-StudentSection-newStudentModal').on('hidden.bs.modal',function(){
            ResetNewStudentFormModal();
        });
    }

    /**
     * Changes the active section and highlights its respective button
     * @Param {string} sectionId - The id of the target section with #
     */
    function ChangeSection(sectionId){
        // Get the DOM objects for the target section/button and the currently active section/button
        let targetButton = $($(sectionId).data('button'));
        let targetSection = $($(sectionId));
        let activeButton = $('.section-button.active').first();
        let activeSection = $(activeButton.data('section'));

        // If the targetSection is the current active section, end function
        if (activeSection.attr('id') === targetSection.attr('id'))
            return;

        // Fade to target section and highlight its respective button
        activeButton.removeClass('active');
        targetButton.addClass('active');
        activeSection.fadeOut('fast').promise().done(function(){
            targetSection.fadeIn('fast');
        });
    }
    /**
     * Registers all jquery.validate validators for all forms
     */
    function Validators(){
        $('#form-StudentSection-newStudent').validate({
            messages: {
                schoolId: "Invalid ID",
                firstName: "Please enter your first name",
                lastName: "Please enter your last name"
            },
            validClass: 'is-valid',
            errorClass: 'is-invalid'
        });
    }

    /**
     * Registers all inputs masks
     */
    function InputMasks(){
        $("#id_schoolId").inputmask(SCHOOL_ID_FORMAT);
        $('#input-StudentSection-schoolId').inputmask(SCHOOL_ID_FORMAT);
        $('#id_dob').inputmask('datetime',{
            inputFormat: 'yyyy-mm-dd',
            placeholder: 'YYYY-MM-DD'
        });

    }

    /**
     * Resets the modal back to its initial state
     */
    function ResetNewStudentFormModal(){
        $('#form-StudentSection-newStudent').validate().resetForm();
        $('#form-StudentSection-newStudent').find('.is-invalid,.is-valid').removeClass('is-invalid').removeClass('is-valid');
        $('#form-StudentSection-newStudent').trigger('reset');
        $('#StudentSection-newStudentFormBody').show();
        $('#StudentSection-newStudentSuccessScreen').hide();
        $('#icon-StudentSection-newStudentLoading').hide();
        $('#text-StudentSection-schoolIdTaken').hide();
        $('#button-StudentSection-newStudentClose,#button-StudentSection-newStudentSubmit').show();
    }

    /**
     * Restart an animation playback for a given element. NOTE: Only works with animation classes
     * @param element - DOM element to apply animation restart
     * @param animationClass - Animation from a class to be restarted
     */
    function RestartAnimation(element,animationClass){
        $(element).removeClass(animationClass);
        $('#button-StudentSection');
        setTimeout(function(){
           $(element).addClass(animationClass);
        },100);
    }

</script>

{% endblock %}
